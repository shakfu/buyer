{{define "content"}}
<header>
    <nav>
        <ul>
            <li><a href="/">‚Üê Back to Home</a></li>
        </ul>
        <ul>
            <li><strong>Requisitions</strong></li>
        </ul>
    </nav>
</header>

<div class="toggle-form">
    <button onclick="toggleForm('add-req-form')">Add New Requisition</button>
</div>

<article id="add-req-form" class="hidden">
    <h2>Add New Requisition</h2>
    <form id="requisition-form" hx-post="/requisitions" hx-target="#reqs-table tbody" hx-swap="beforeend">
        <label for="req_name">
            Requisition Name
            <input type="text" id="req_name" name="name" placeholder="e.g., Q1 2025 Equipment" required>
        </label>
        <label for="justification">
            Justification (optional)
            <textarea id="justification" name="justification" rows="3" placeholder="Reason for this requisition..."></textarea>
        </label>
        <label for="budget">
            Overall Budget (optional)
            <input type="number" id="budget" name="budget" placeholder="5000.00" step="0.01" min="0">
            <small>Total budget limit for this requisition - provides slack for line items</small>
        </label>

        <fieldset>
            <legend>Line Items</legend>
            <div id="line-items">
                <div class="line-item" data-item-index="0">
                    <label>
                        Specification
                        <select name="items[0][specification_id]" required>
                            <option value="">Select a specification...</option>
                            {{range .Specifications}}
                            <option value="{{.ID}}">{{.Name}}</option>
                            {{end}}
                        </select>
                    </label>
                    <label>
                        Quantity
                        <input type="number" name="items[0][quantity]" placeholder="2" min="1" required>
                    </label>
                    <label>
                        Budget Per Unit (optional)
                        <input type="number" name="items[0][budget_per_unit]" placeholder="500.00" step="0.01" min="0">
                    </label>
                    <label>
                        Description (optional)
                        <input type="text" name="items[0][description]" placeholder="Additional details...">
                    </label>
                </div>
            </div>
            <button type="button" onclick="addLineItem()" class="secondary">Add Another Item</button>
        </fieldset>

        <button type="submit">Create Requisition</button>
        <button type="button" onclick="cancelRequisition()" class="secondary">Cancel</button>
    </form>
</article>

<figure id="reqs-table">
    <table role="grid">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Items</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Requisitions}}
            <tr id="req-{{.ID}}">
                <td>{{.ID}}</td>
                <td>
                    <span class="req-name">
                        {{.Name}}
                        {{if .Justification}}<br><small>{{.Justification}}</small>{{end}}
                        {{if ne .Budget 0.0}}<br><strong>Budget: {{printf "%.2f" .Budget}}</strong>{{end}}
                    </span>
                    <form class="hidden edit-form" hx-put="/requisitions/{{.ID}}" hx-target="#req-{{.ID}}" hx-swap="outerHTML">
                        <input type="text" name="name" value="{{.Name}}" required>
                        <textarea name="justification" rows="2" placeholder="Justification...">{{.Justification}}</textarea>
                        <input type="number" name="budget" value="{{.Budget}}" step="0.01" min="0" placeholder="Budget...">
                    </form>
                </td>
                <td>
                    <ul>
                        {{range .Items}}
                        <li id="item-{{.ID}}">
                            <span class="item-display">
                                {{if .Specification}}{{.Specification.Name}}{{end}}
                                (Qty: {{.Quantity}}{{if ne .BudgetPerUnit 0.0}}, Budget/unit: {{printf "%.2f" .BudgetPerUnit}}{{end}})
                                {{if .Description}} - {{.Description}}{{end}}
                            </span>
                            <form class="hidden item-edit-form" hx-put="/requisition-items/{{.ID}}" hx-target="#item-{{.ID}}" hx-swap="outerHTML">
                                <select name="specification_id" required>
                                    {{$currentSpecID := .SpecificationID}}
                                    {{range $.Specifications}}
                                    <option value="{{.ID}}"{{if eq .ID $currentSpecID}} selected{{end}}>{{.Name}}</option>
                                    {{end}}
                                </select>
                                <input type="number" name="quantity" value="{{.Quantity}}" min="1" required placeholder="Qty">
                                <input type="number" name="budget_per_unit" value="{{.BudgetPerUnit}}" step="0.01" min="0" placeholder="Budget/unit">
                                <input type="text" name="description" value="{{.Description}}" placeholder="Description">
                            </form>
                            <button class="btn-sm secondary" onclick="toggleItemEdit({{.ID}})">Edit</button>
                            <button class="btn-sm contrast"
                                    hx-delete="/requisition-items/{{.ID}}"
                                    hx-target="#item-{{.ID}}"
                                    hx-swap="outerHTML"
                                    hx-confirm="Delete this item?">
                                Delete
                            </button>
                        </li>
                        {{end}}
                    </ul>
                </td>
                <td>
                    <div class="actions">
                        <button class="btn-sm secondary" onclick="toggleReqEdit({{.ID}})">Edit</button>
                        <button class="btn-sm contrast"
                                hx-delete="/requisitions/{{.ID}}"
                                hx-target="#req-{{.ID}}"
                                hx-swap="outerHTML"
                                hx-confirm="Are you sure you want to delete this requisition?">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</figure>

<script>
let itemIndex = 1;
const specifications = [
    {{range .Specifications}}
    {id: {{.ID}}, name: "{{.Name}}"},
    {{end}}
];

function addLineItem() {
    const container = document.getElementById('line-items');
    const newItem = document.createElement('div');
    newItem.className = 'line-item';
    newItem.setAttribute('data-item-index', itemIndex);

    let specOptions = '<option value="">Select a specification...</option>';
    specifications.forEach(spec => {
        specOptions += `<option value="${spec.id}">${spec.name}</option>`;
    });

    newItem.innerHTML = `
        <hr>
        <label>
            Specification
            <select name="items[${itemIndex}][specification_id]" required>
                ${specOptions}
            </select>
        </label>
        <label>
            Quantity
            <input type="number" name="items[${itemIndex}][quantity]" placeholder="2" min="1" required>
        </label>
        <label>
            Budget Per Unit (optional)
            <input type="number" name="items[${itemIndex}][budget_per_unit]" placeholder="500.00" step="0.01" min="0">
        </label>
        <label>
            Description (optional)
            <input type="text" name="items[${itemIndex}][description]" placeholder="Additional details...">
        </label>
        <button type="button" onclick="removeLineItem(${itemIndex})" class="secondary btn-sm">Remove Item</button>
    `;

    container.appendChild(newItem);
    itemIndex++;
}

function removeLineItem(index) {
    const item = document.querySelector(`[data-item-index="${index}"]`);
    if (item) {
        item.remove();
    }
}

function cancelRequisition() {
    // Reset form
    document.getElementById('requisition-form').reset();
    // Remove all added line items except the first
    const items = document.querySelectorAll('.line-item');
    items.forEach((item, idx) => {
        if (idx > 0) item.remove();
    });
    itemIndex = 1;
    // Hide form
    toggleForm('add-req-form');
}

// Handle successful form submission
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'reqs-table') {
        cancelRequisition();
    }
});

// Toggle requisition edit mode
function toggleReqEdit(id) {
    const row = document.getElementById('req-' + id);
    const nameSpan = row.querySelector('.req-name');
    const form = row.querySelector('.edit-form');
    const editBtn = row.querySelector('.secondary');

    if (form.classList.contains('hidden')) {
        nameSpan.classList.add('hidden');
        form.classList.remove('hidden');
        editBtn.textContent = 'Save';
        editBtn.onclick = function() {
            htmx.trigger(form, 'submit');
        };
    } else {
        nameSpan.classList.remove('hidden');
        form.classList.add('hidden');
        editBtn.textContent = 'Edit';
        editBtn.onclick = function() { toggleReqEdit(id); };
    }
}

// Toggle line item edit mode
function toggleItemEdit(id) {
    const item = document.getElementById('item-' + id);
    const displaySpan = item.querySelector('.item-display');
    const form = item.querySelector('.item-edit-form');
    const editBtn = item.querySelector('.btn-sm.secondary');

    if (form.classList.contains('hidden')) {
        displaySpan.classList.add('hidden');
        form.classList.remove('hidden');
        editBtn.textContent = 'Save';
        editBtn.onclick = function() {
            htmx.trigger(form, 'submit');
        };
    } else {
        displaySpan.classList.remove('hidden');
        form.classList.add('hidden');
        editBtn.textContent = 'Edit';
        editBtn.onclick = function() { toggleItemEdit(id); };
    }
}
</script>
{{end}}
