{{define "content"}}
{{template "breadcrumb" .}}

<div class="toggle-form">
    <button onclick="toggleForm('add-project-form')">Add New Project</button>
</div>

<article id="add-project-form" class="hidden">
    <h2>Add New Project</h2>
    <form hx-post="/projects" hx-target="#projects-table tbody" hx-swap="beforeend">
        <label for="name">
            Project Name
            <input type="text" id="name" name="name" placeholder="Enter project name" required>
        </label>
        <label for="description">
            Description
            <textarea id="description" name="description" placeholder="Project description" rows="3"></textarea>
        </label>
        <label for="budget">
            Budget
            <input type="number" id="budget" name="budget" placeholder="0.00" step="0.01" min="0">
        </label>
        <label for="deadline">
            Deadline
            <input type="date" id="deadline" name="deadline">
        </label>
        <button type="submit">Create Project</button>
        <button type="button" onclick="toggleForm('add-project-form')" class="secondary">Cancel</button>
    </form>
</article>

<figure id="projects-table">
    <table role="grid">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Status</th>
                <th>Budget</th>
                <th>Deadline</th>
                <th>BOM Items</th>
                <th>Requisitions</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Projects}}
            <tr id="project-{{.ID}}">
                <td>{{.ID}}</td>
                <td>
                    <strong>{{.Name}}</strong>
                    {{if .Description}}<br><small>{{.Description}}</small>{{end}}
                </td>
                <td>
                    <span class="badge {{if eq .Status "planning"}}secondary{{else if eq .Status "active"}}primary{{else if eq .Status "completed"}}success{{else}}contrast{{end}}">
                        {{.Status}}
                    </span>
                </td>
                <td>{{if gt .Budget 0.0}}${{printf "%.2f" .Budget}}{{else}}-{{end}}</td>
                <td>{{if .Deadline}}{{.Deadline.Format "2006-01-02"}}{{else}}-{{end}}</td>
                <td>{{if .BillOfMaterials}}{{len .BillOfMaterials.Items}}{{else}}0{{end}}</td>
                <td>{{len .Requisitions}}</td>
                <td>
                    <div class="actions">
                        <a href="/projects/{{.ID}}" class="btn-sm" role="button">View</a>
                        <button class="btn-sm secondary" onclick="toggleProjectEdit({{.ID}})">Edit</button>
                        <button class="btn-sm contrast"
                                hx-delete="/projects/{{.ID}}"
                                hx-target="#project-{{.ID}}"
                                hx-swap="outerHTML"
                                hx-confirm="Are you sure you want to delete this project and its Bill of Materials?">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</figure>

<script>
function toggleProjectEdit(id) {
    const name = prompt("Enter new project name:");
    if (!name) return;

    const description = prompt("Enter description (optional):");
    const budget = prompt("Enter budget (optional):");
    const deadline = prompt("Enter deadline YYYY-MM-DD (optional):");
    const status = prompt("Enter status (planning/active/completed/cancelled):");

    const formData = new FormData();
    formData.append('name', name);
    if (description) formData.append('description', description);
    if (budget) formData.append('budget', budget);
    if (deadline) formData.append('deadline', deadline);
    if (status) formData.append('status', status);

    fetch(`/projects/${id}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById(`project-${id}`).outerHTML = html;
    });
}
</script>
{{end}}
