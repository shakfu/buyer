{{define "content"}}
{{template "breadcrumb" .}}

<article>
    <header>
        <h1>{{.Product.Name}}</h1>
        {{if .Product.SKU}}<p><strong>SKU:</strong> {{.Product.SKU}}</p>{{end}}
    </header>

    {{if .Product.Description}}
    <section>
        <h3>Description</h3>
        <p>{{.Product.Description}}</p>
    </section>
    {{end}}

    <section>
        <h3>Product Information</h3>
        <dl>
            <dt>Brand</dt>
            <dd>{{if .Product.Brand}}{{.Product.Brand.Name}}{{else}}-{{end}}</dd>

            <dt>Specification</dt>
            <dd>{{if .Product.Specification}}{{.Product.Specification.Name}}{{else}}-{{end}}</dd>

            <dt>Unit of Measure</dt>
            <dd>{{.Product.UnitOfMeasure}}</dd>

            {{if gt .Product.MinOrderQty 0}}
            <dt>Minimum Order Quantity</dt>
            <dd>{{.Product.MinOrderQty}} {{.Product.UnitOfMeasure}}</dd>
            {{end}}

            {{if gt .Product.LeadTimeDays 0}}
            <dt>Lead Time</dt>
            <dd>{{.Product.LeadTimeDays}} days</dd>
            {{end}}

            <dt>Status</dt>
            <dd>
                {{if .Product.IsActive}}
                    <span style="color: green;">Active</span>
                {{else}}
                    <span style="color: red;">Inactive</span>
                {{end}}
                {{if .Product.DiscontinuedAt}}
                    <br><small>Discontinued on {{.Product.DiscontinuedAt.Format "2006-01-02"}}</small>
                {{end}}
            </dd>
        </dl>
    </section>

    {{if .Product.CreatedBy}}
    <section>
        <h3>Audit Information</h3>
        <dl>
            <dt>Created By</dt>
            <dd>{{.Product.CreatedBy}} on {{.Product.CreatedAt.Format "2006-01-02 15:04"}}</dd>

            {{if .Product.UpdatedBy}}
            <dt>Updated By</dt>
            <dd>{{.Product.UpdatedBy}} on {{.Product.UpdatedAt.Format "2006-01-02 15:04"}}</dd>
            {{end}}
        </dl>
    </section>
    {{end}}

    {{if .Product.Specification}}
    <section>
        <h3>Product Specifications</h3>
        <div class="toggle-form">
            <button onclick="toggleForm('edit-attrs-form')">Edit Attributes</button>
        </div>

        {{if .Product.Attributes}}
        <dl id="attrs-display">
            {{range .Product.Attributes}}
            <dt>
                {{.SpecificationAttribute.Name}}
                {{if .SpecificationAttribute.Unit}}
                    <small>({{.SpecificationAttribute.Unit}})</small>
                {{end}}
            </dt>
            <dd>
                {{if .ValueNumber}}
                    {{printf "%.2f" (deref .ValueNumber)}}
                {{else if .ValueText}}
                    {{deref .ValueText}}
                {{else if .ValueBoolean}}
                    {{if (deref .ValueBoolean)}}Yes{{else}}No{{end}}
                {{end}}
            </dd>
            {{end}}
        </dl>
        {{else}}
        <p>No attribute values set yet.</p>
        {{end}}

        <article id="edit-attrs-form" class="hidden">
            <h4>Edit Attribute Values</h4>
            <form hx-post="/products/{{.Product.ID}}/attributes"
                  hx-target="#attrs-display"
                  hx-swap="outerHTML"
                  hx-on::after-request="if(event.detail.successful) toggleForm('edit-attrs-form')">
                {{if .AvailableAttributes}}
                    {{range $attr := .AvailableAttributes}}
                    <label for="attr-{{$attr.ID}}">
                        {{$attr.Name}}
                        {{if $attr.IsRequired}}<span style="color: red;">*</span>{{end}}
                        {{if $attr.Unit}}<small>({{$attr.Unit}})</small>{{end}}
                        {{if $attr.Description}}<br><small>{{$attr.Description}}</small>{{end}}

                        {{if eq $attr.DataType "number"}}
                            <input type="number" id="attr-{{$attr.ID}}" name="attr_{{$attr.ID}}" step="any"
                                   value="{{range $.Product.Attributes}}{{if eq .SpecificationAttributeID $attr.ID}}{{if .ValueNumber}}{{deref .ValueNumber}}{{end}}{{end}}{{end}}"
                                   {{if $attr.IsRequired}}required{{end}}
                                   {{if $attr.MinValue}}min="{{$attr.MinValue}}"{{end}}
                                   {{if $attr.MaxValue}}max="{{$attr.MaxValue}}"{{end}}>
                        {{else if eq $attr.DataType "text"}}
                            <input type="text" id="attr-{{$attr.ID}}" name="attr_{{$attr.ID}}"
                                   value="{{range $.Product.Attributes}}{{if eq .SpecificationAttributeID $attr.ID}}{{if .ValueText}}{{deref .ValueText}}{{end}}{{end}}{{end}}"
                                   {{if $attr.IsRequired}}required{{end}}>
                        {{else if eq $attr.DataType "boolean"}}
                            <select id="attr-{{$attr.ID}}" name="attr_{{$attr.ID}}" {{if $attr.IsRequired}}required{{end}}>
                                <option value="">-- Select --</option>
                                <option value="true" {{range $.Product.Attributes}}{{if eq .SpecificationAttributeID $attr.ID}}{{if (deref .ValueBoolean)}}selected{{end}}{{end}}{{end}}>Yes</option>
                                <option value="false" {{range $.Product.Attributes}}{{if eq .SpecificationAttributeID $attr.ID}}{{if not (deref .ValueBoolean)}}selected{{end}}{{end}}{{end}}>No</option>
                            </select>
                        {{end}}
                    </label>
                    {{end}}
                    <button type="submit">Save Attributes</button>
                    <button type="button" onclick="toggleForm('edit-attrs-form')" class="secondary">Cancel</button>
                {{else}}
                    <p>No attributes defined for this specification. <a href="/specifications/{{.Product.SpecificationID}}/attributes">Manage Attributes</a></p>
                {{end}}
            </form>
        </article>
    </section>
    {{end}}

    {{if .Product.Quotes}}
    <section>
        <h3>Price Quotes ({{len .Product.Quotes}})</h3>
        <figure>
            <table role="grid">
                <thead>
                    <tr>
                        <th>Vendor</th>
                        <th>Price</th>
                        <th>Price (USD)</th>
                        <th>Min Qty</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Product.Quotes}}
                    <tr>
                        <td>{{if .Vendor}}{{.Vendor.Name}}{{end}}</td>
                        <td>{{printf "%.2f" .Price}} {{.Currency}}</td>
                        <td>{{printf "%.2f" .ConvertedPrice}}</td>
                        <td>{{if gt .MinQuantity 0}}{{.MinQuantity}}{{else}}-{{end}}</td>
                        <td>
                            {{if eq .Status "active"}}
                                <span style="color: green;">Active</span>
                            {{else if eq .Status "accepted"}}
                                <span style="color: blue;">Accepted</span>
                            {{else if eq .Status "superseded"}}
                                <span style="color: orange;">Superseded</span>
                            {{else if eq .Status "expired"}}
                                <span style="color: red;">Expired</span>
                            {{else if eq .Status "declined"}}
                                <span style="color: gray;">Declined</span>
                            {{else}}
                                {{.Status}}
                            {{end}}
                        </td>
                        <td>{{.QuoteDate.Format "2006-01-02"}}</td>
                        <td><a href="/quotes/{{.ID}}" role="button" class="secondary">View</a></td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </figure>
    </section>
    {{end}}

    <footer>
        <a href="/products" role="button" class="secondary">Back to Products</a>
        {{if .Product.Quotes}}
        <a href="/quotes/compare/product/{{.Product.ID}}" role="button">Compare Quotes</a>
        {{end}}
        <button class="contrast"
                hx-delete="/products/{{.Product.ID}}"
                hx-confirm="Are you sure you want to delete this product?"
                hx-on::after-request="if(event.detail.successful) window.location.href='/products'">
            Delete Product
        </button>
    </footer>
</article>
{{end}}
