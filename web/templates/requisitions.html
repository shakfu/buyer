{{define "content"}}
{{template "breadcrumb" .}}

<div class="toggle-form">
    <button onclick="toggleForm('add-req-form')">Add New Requisition</button>
</div>

<article id="add-req-form" class="hidden">
    <h2>Add New Requisition</h2>
    <form id="requisition-form" hx-post="/requisitions" hx-target="#reqs-table tbody" hx-swap="beforeend">
        <label for="req_name">
            Requisition Name
            <input type="text" id="req_name" name="name" placeholder="e.g., Q1 2025 Equipment" required>
        </label>
        <label for="justification">
            Justification (optional)
            <textarea id="justification" name="justification" rows="3" placeholder="Reason for this requisition..."></textarea>
        </label>
        <label for="budget">
            Overall Budget (optional)
            <input type="number" id="budget" name="budget" placeholder="5000.00" step="0.01" min="0">
            <small>Total budget limit for this requisition - provides slack for line items</small>
        </label>

        <fieldset>
            <legend>Line Items</legend>
            <div id="line-items">
                <div class="line-item" data-item-index="0">
                    <label>
                        Specification
                        <select name="items[0][specification_id]" required>
                            <option value="">Select a specification...</option>
                            {{range .Specifications}}
                            <option value="{{.ID}}">{{.Name}}</option>
                            {{end}}
                        </select>
                    </label>
                    <label>
                        Quantity
                        <input type="number" name="items[0][quantity]" placeholder="2" min="1" required>
                    </label>
                    <label>
                        Budget Per Unit (optional)
                        <input type="number" name="items[0][budget_per_unit]" placeholder="500.00" step="0.01" min="0">
                    </label>
                    <label>
                        Description (optional)
                        <input type="text" name="items[0][description]" placeholder="Additional details...">
                    </label>
                </div>
            </div>
            <button type="button" onclick="addLineItem()" class="secondary">Add Another Item</button>
        </fieldset>

        <button type="submit">Create Requisition</button>
        <button type="button" onclick="cancelRequisition()" class="secondary">Cancel</button>
    </form>
</article>

<figure id="reqs-table">
    <table role="grid">
        <thead>
            <tr>
                <th style="width: 5%">ID</th>
                <th style="width: 35%">Name</th>
                <th style="width: 10%">Items</th>
                <th style="width: 15%">Budget</th>
                <th style="width: 35%">Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Requisitions}}
            <tr id="req-{{.ID}}">
                <td>{{.ID}}</td>
                <td>
                    <strong>{{.Name}}</strong>
                    {{if .Justification}}<br><small>{{.Justification}}</small>{{end}}
                </td>
                <td>{{len .Items}}</td>
                <td>{{if ne .Budget 0.0}}{{printf "%.2f" .Budget}}{{else}}-{{end}}</td>
                <td>
                    <div class="actions">
                        <button class="btn-sm" onclick="toggleDetails({{.ID}})">Details</button>
                        <button class="btn-sm secondary" onclick="toggleEdit({{.ID}})">Edit</button>
                        <button class="btn-sm contrast"
                                hx-delete="/requisitions/{{.ID}}"
                                hx-target="#req-{{.ID}}"
                                hx-swap="delete"
                                hx-confirm="Are you sure you want to delete this requisition?">
                            Delete
                        </button>
                    </div>
                </td>
            </tr>
            <!-- Details row (hidden by default) -->
            <tr id="details-{{.ID}}" class="hidden">
                <td colspan="5">
                    <article>
                        <h4>Line Items</h4>
                        <ul>
                            {{range .Items}}
                            <li>
                                <strong>{{if .Specification}}{{.Specification.Name}}{{end}}</strong>
                                - Qty: {{.Quantity}}
                                {{if ne .BudgetPerUnit 0.0}}, Budget/unit: {{printf "%.2f" .BudgetPerUnit}}{{end}}
                                {{if .Description}}<br><small>{{.Description}}</small>{{end}}
                            </li>
                            {{end}}
                        </ul>
                    </article>
                </td>
            </tr>
            <!-- Edit row (hidden by default) -->
            <tr id="edit-{{.ID}}" class="hidden">
                <td colspan="5">
                    <article>
                        <h4>Edit Requisition</h4>
                        <form hx-put="/requisitions/{{.ID}}/full" hx-target="#req-{{.ID}}" hx-swap="outerHTML">
                            <label>
                                Name
                                <input type="text" name="name" value="{{.Name}}" required>
                            </label>
                            <label>
                                Justification
                                <textarea name="justification" rows="2">{{.Justification}}</textarea>
                            </label>
                            <label>
                                Budget
                                <input type="number" name="budget" value="{{.Budget}}" step="0.01" min="0">
                            </label>

                            <fieldset>
                                <legend>Line Items</legend>
                                <div id="edit-items-{{.ID}}">
                                    {{range $index, $item := .Items}}
                                    <div class="edit-item" data-item-id="{{$item.ID}}">
                                        <input type="hidden" name="items[{{$index}}][id]" value="{{$item.ID}}">
                                        <label>
                                            Specification
                                            <select name="items[{{$index}}][specification_id]" required>
                                                {{$currentSpecID := $item.SpecificationID}}
                                                {{range $.Specifications}}
                                                <option value="{{.ID}}"{{if eq .ID $currentSpecID}} selected{{end}}>{{.Name}}</option>
                                                {{end}}
                                            </select>
                                        </label>
                                        <label>
                                            Quantity
                                            <input type="number" name="items[{{$index}}][quantity]" value="{{$item.Quantity}}" min="1" required>
                                        </label>
                                        <label>
                                            Budget/Unit
                                            <input type="number" name="items[{{$index}}][budget_per_unit]" value="{{$item.BudgetPerUnit}}" step="0.01" min="0">
                                        </label>
                                        <label>
                                            Description
                                            <input type="text" name="items[{{$index}}][description]" value="{{$item.Description}}">
                                        </label>
                                        <button type="button" class="btn-sm contrast" onclick="removeEditItem({{$item.ID}})">Remove</button>
                                        <hr>
                                    </div>
                                    {{end}}
                                </div>
                                <button type="button" class="secondary" onclick="addEditItem({{.ID}})">Add Item</button>
                            </fieldset>

                            <button type="submit">Save Changes</button>
                            <button type="button" class="secondary" onclick="toggleEdit({{.ID}})">Cancel</button>
                        </form>
                    </article>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</figure>

<script>
let itemIndex = 1;
const specifications = [
    {{range .Specifications}}
    {id: {{.ID}}, name: "{{.Name}}"},
    {{end}}
];

// For creating new requisition
function addLineItem() {
    const container = document.getElementById('line-items');
    const newItem = document.createElement('div');
    newItem.className = 'line-item';
    newItem.setAttribute('data-item-index', itemIndex);

    let specOptions = '<option value="">Select a specification...</option>';
    specifications.forEach(spec => {
        specOptions += `<option value="${spec.id}">${spec.name}</option>`;
    });

    newItem.innerHTML = `
        <hr>
        <label>
            Specification
            <select name="items[${itemIndex}][specification_id]" required>
                ${specOptions}
            </select>
        </label>
        <label>
            Quantity
            <input type="number" name="items[${itemIndex}][quantity]" placeholder="2" min="1" required>
        </label>
        <label>
            Budget Per Unit (optional)
            <input type="number" name="items[${itemIndex}][budget_per_unit]" placeholder="500.00" step="0.01" min="0">
        </label>
        <label>
            Description (optional)
            <input type="text" name="items[${itemIndex}][description]" placeholder="Additional details...">
        </label>
        <button type="button" onclick="removeLineItem(${itemIndex})" class="secondary btn-sm">Remove Item</button>
    `;

    container.appendChild(newItem);
    itemIndex++;
}

function removeLineItem(index) {
    const item = document.querySelector(`[data-item-index="${index}"]`);
    if (item) {
        item.remove();
    }
}

function cancelRequisition() {
    document.getElementById('requisition-form').reset();
    const items = document.querySelectorAll('.line-item');
    items.forEach((item, idx) => {
        if (idx > 0) item.remove();
    });
    itemIndex = 1;
    toggleForm('add-req-form');
}

// Toggle details view
function toggleDetails(id) {
    const detailsRow = document.getElementById('details-' + id);
    const editRow = document.getElementById('edit-' + id);

    // Hide edit row if open
    if (!editRow.classList.contains('hidden')) {
        editRow.classList.add('hidden');
    }

    // Toggle details
    detailsRow.classList.toggle('hidden');
}

// Toggle edit mode
function toggleEdit(id) {
    const detailsRow = document.getElementById('details-' + id);
    const editRow = document.getElementById('edit-' + id);

    // Hide details row if open
    if (!detailsRow.classList.contains('hidden')) {
        detailsRow.classList.add('hidden');
    }

    // Toggle edit
    editRow.classList.toggle('hidden');
}

// For editing existing requisition items
function addEditItem(reqId) {
    const container = document.getElementById('edit-items-' + reqId);
    const items = container.querySelectorAll('.edit-item');
    const newIndex = items.length;

    const newItem = document.createElement('div');
    newItem.className = 'edit-item';
    newItem.setAttribute('data-item-id', 'new-' + newIndex);

    let specOptions = '';
    specifications.forEach(spec => {
        specOptions += `<option value="${spec.id}">${spec.name}</option>`;
    });

    newItem.innerHTML = `
        <input type="hidden" name="items[${newIndex}][id]" value="0">
        <label>
            Specification
            <select name="items[${newIndex}][specification_id]" required>
                ${specOptions}
            </select>
        </label>
        <label>
            Quantity
            <input type="number" name="items[${newIndex}][quantity]" value="1" min="1" required>
        </label>
        <label>
            Budget/Unit
            <input type="number" name="items[${newIndex}][budget_per_unit]" value="0" step="0.01" min="0">
        </label>
        <label>
            Description
            <input type="text" name="items[${newIndex}][description]">
        </label>
        <button type="button" class="btn-sm contrast" onclick="removeEditItem('new-${newIndex}')">Remove</button>
        <hr>
    `;

    container.appendChild(newItem);
}

function removeEditItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        item.remove();
    }
}

// Handle successful form submission
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.matches('#reqs-table tbody')) {
        cancelRequisition();
    }
});
</script>
{{end}}
