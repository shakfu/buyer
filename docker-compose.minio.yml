version: '3.8'

services:
  minio:
    image: quay.io/minio/minio:latest
    container_name: buyer-minio
    ports:
      - "9000:9000"   # MinIO API
      - "9001:9001"   # MinIO Console
    environment:
      # Root credentials (change in production!)
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}

      # Optional: Set region
      MINIO_REGION: ${MINIO_REGION:-us-east-1}

      # Optional: Enable browser access
      MINIO_BROWSER: ${MINIO_BROWSER:-on}

      # Optional: Prometheus metrics
      MINIO_PROMETHEUS_AUTH_TYPE: ${MINIO_PROMETHEUS_AUTH_TYPE:-public}
    volumes:
      # Persistent storage
      - minio_data:/data

      # Optional: TLS certificates (uncomment for HTTPS)
      # - ./certs:/root/.minio/certs
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - buyer-network

  # Optional: MinIO Client for setup automation
  mc:
    image: minio/mc:latest
    container_name: buyer-mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO to be ready...';
      sleep 5;
      /usr/bin/mc alias set buyerlocal http://minio:9000 minioadmin minioadmin;
      /usr/bin/mc mb --ignore-existing buyerlocal/vendor-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/product-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/quote-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/po-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/requisition-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/project-docs;
      /usr/bin/mc mb --ignore-existing buyerlocal/brand-docs;
      /usr/bin/mc version enable buyerlocal/vendor-docs;
      /usr/bin/mc version enable buyerlocal/quote-docs;
      /usr/bin/mc version enable buyerlocal/po-docs;
      echo 'MinIO setup completed!';
      echo 'Buckets created:';
      /usr/bin/mc ls buyerlocal;
      exit 0;
      "
    networks:
      - buyer-network

volumes:
  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${MINIO_DATA_DIR:-./data/minio}

networks:
  buyer-network:
    driver: bridge

# Usage:
#
# 1. Start MinIO:
#    docker-compose -f docker-compose.minio.yml up -d
#
# 2. Access MinIO Console:
#    http://localhost:9001
#    Username: minioadmin
#    Password: minioadmin
#
# 3. Access MinIO API:
#    http://localhost:9000
#
# 4. Check logs:
#    docker-compose -f docker-compose.minio.yml logs -f minio
#
# 5. Stop MinIO:
#    docker-compose -f docker-compose.minio.yml down
#
# 6. Stop and remove data:
#    docker-compose -f docker-compose.minio.yml down -v
#
# Environment Variables (optional):
# Create a .env file with:
#   MINIO_ROOT_USER=your-access-key
#   MINIO_ROOT_PASSWORD=your-secret-key
#   MINIO_DATA_DIR=/path/to/data
#   MINIO_REGION=us-east-1
